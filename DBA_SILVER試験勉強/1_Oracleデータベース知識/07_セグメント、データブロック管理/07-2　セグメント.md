# セグメント領域管理方式２種類
「行データを格納するために十分な空き容量があるブロック」を高速で探し出す仕組み
## 自動セグメント領域管理(ASSM)
・各ブロックを領域使用率に基づいてツリー形式に4つに分けて管理
・INSERT時、INSERTする行のサイズに適した空き容量のブロックを探す
・空き容量が不足すると自動的にセグメントの拡張(エクステントを追加)する
### 自動セグメント管理方式をとる表領域の作成

`CREATE TABLESPACE tbs_auto`
 `DATAFILE '/u01/app/oracle/tbs_auto01.dbf'`
 `SIZE 100M`
 `SEGMENT SPACE MANAGEMENT AUTO;`

or

`CREATE TABLESPACE tbs_auto`
 `DATAFILE '/u01/app/oracle/tbs_auto01.dbf'`
 `SIZE 100M;`

※ローカル管理表領域である必要がある
## 手動セグメント領域管理方式
・空きブロックをリスト形式で管理
・表レベルの設定項目が(PCTFREE,PCTUSED・・・)多い

`CREATE TABLESPACE tbs_auto`
 `DATAFILE '/u01/app/oracle/tbs_auto01.dbf'`
 `SIZE 100M`
 `SEGMENT SPACE MANAGEMENT MANUAL;`

※ローカル管理表領域である必要がある
# 再開可能領域割り当て
セグメント拡張エラーが発生時に、処理を最初から再度実行するというのは非効率なので「RESUMABLE_TIMEOUT初期化パラメータ」に設定した秒数だけ強制終了を待つ機能
→セグメント拡張エラーは、表領域でデータファイルの自動拡張がOFFになっているときにデータが挿入されセグメントの拡張が失敗した際に発生する
## 動作するタイミング
・表領域の空き容量不足により追加エクステント割り当てに失敗した場合
・ユーザのクオータを超過した場合
・セグメントの最大エクステント数に達した場合(ディクショナリ管理表領域のみ)
## 再開可能文
再開可能割り当て機能を使用できるSQL文を再開可能文という
・一時表領域を使うSELECT文
・DML
・ロード系処理
・DDL
## 再開可能文が一時停止した際に実行される処理
・エラーがアラートログに記録される
・「AFTER SUSPENDイベント」に対してトリガー登録してる処理が実行
# 遅延セグメント作成
オブジェクトにデータが格納されるまでセグメント作成しない機能
## 利点
・データが空の表が沢山ある場合にデータの節約になる
・大量の表を作成するときにメモリの節約になる

※SYSユーザが所有するセグメントにはこの機能は無効
## 使用法
### ①「DEFFERRED_SEGMENT_CREATION初期化パラメータ」をtrueに設定してからセグメントを作る
### ②CREATE TABLE文にSEGMENT CREATION DEFFERRED句を指定する

`CREATE TABLE users (`
    `user_id   NUMBER,`
    `username  VARCHAR2(100)`
`)`
`SEGMENT CREATION DEFERRED;`
# セグメントの縮小
セグメントに格納したデータが削除された際にできる
## HWM
「そのセグメントのどこまでデータが格納されたことがあるか」を表す水準
表セグメントのオンライン縮小で正しい位置に調整できる
![[Pasted image 20250601100838.png]]
## ①オンライン縮小()
`ALTER TABLE EMPLOYEES SHRINK SPACE;`

この情報からわかることは・・・

## ①HWMが調整される

HWM(High Water Mark)とは・・・
「そのセグメントのどこまでデータが買う脳されたことがあるか」

なんで？
COMPACT句がないため
→HWMを引き下げてHWM以降の領域を解放する
あったら？
→HWMは引き下げるが領域の開放はしない
CASCADE句があったら？
→表に作成されている索引に対しても縮小処理をする

## ②行移行が解消するかもしれない

行移行とは・・・
行サイズが拡張するようなUPDATE分を実行したとき、拡張したデータがブロックの空き容量に収まらずに別のブロックに格納された状態

なんで？
セグメントの縮小はそもそも行の移動によって行われるので、治るかもしれない

## ③ローカル管理方式で管理されている表領域である
なんで？
そもそもローカル管理方式にしないとセグメントの縮小ができない

## ④索引を再構築する必要がない
なんで？
セグメント縮小をすると自動で索引の再構築をしてくれる

---
# 特殊なセグメント2種

| 分類        | 説明    | 格納される場所 |
| --------- | ----- | ------- |
| UNDOセグメント | 過去データ | UNDO表領域 |
| 一時セグメント   | 一時データ | 一時表領域   |

上記２つが常にその表領域に格納されるわけではない・・・
例外がある・・・

・一時UNDO機能を使用したときに、UNDOセグメントが一時表領域に格納される
・一時表領域を作成中、一時セグメントが永続表領域に作成される

## UNDOセグメントについて

・UNDOセグメントには１つまたは複数のトランザクションが対応する
・最後のエクステントがトランザクションで埋まったら・・・
①追加でエクステントが割り当てられる
②最初のエクステントに上書きされる
上記２つの動作をする





# 表圧縮の種類２つ

基本表圧縮

高度な表圧縮