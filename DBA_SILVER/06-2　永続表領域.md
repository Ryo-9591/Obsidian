# 永続表領域
表や索引などに対応するオブジェクトを通常のセグメントに格納し管理
・１つ以上のデータファイルからなる
## 永続表領域の種類
役割に応じた永続表領域がある
### SYSTEM表領域
・データディクショナリを格納
・常にオンラインである必要がある
### SYSAUX表領域
・SYSTEm表領域の補佐
・管理情報を格納
## 永続表領域の作成(smallfile表領域、ローカル管理、エクステントサイズ自動)

`CREATE TABELSPACE mytbs`
`DATAFILE '/u1/app/oracle/mytbs01.dbf'　--１つ目`
`SIZE 100M`
`AUTOEXTEND OFF ,　--自動拡張OFF`
`'/u1/app/oracle/mytbs02.dbf'　--２つ目`
`SIZE 200M`
`AUTOEXTEND ON 　----自動拡張ON`

・「EXTENT MANAGEMET DICTIONARY」の指定がないためローカル管理
・エクステント割り当てはデフォルト「AUTOALLOCATE」になるので64KB,128KBなどからエクステントごとに自動的にサイズを決定
・均一サイズにするには「UNIFORM」を指定する必要がある
## 永続表領域の作成(smallfile表領域、ディクショナリ管理)

`CREATE TABLESPACE example_ts`
`DATAFILE '/u01/app/oracle/oradata/ORCL/example01.dbf'` 
`SIZE 50M`
`EXTENT MANAGEMENT DICTIONARY`

・「EXTENT MANAGEMET DICTIONARY」の指定があるためディクショナリ管理
## 永続表領域の作成(smallfile表領域、OMF管理)

`CREATE TABLE PAYMENT_TBS;`

・DATAFILEの指定がないためOMF管理
## 永続表領域の作成(bigfile表領域)

`CREATE TABLESPACE bigtbs` 
`DATAFILE '/u01/app/oracle/bigtbs.dbf'` 
`SIZE 50G`

・1つのデータファイルだけで構成
・smallfile表領域への変更はできない
# ローカル管理方式とディクショナリ管理方式

## ローカル管理方式
- エクステントサイズ自動決定
- 自動セグメント領域管理(ASSM)
- bigfile表領域作れる
- 遅延セグメント作成
- セグメント縮小できる→「ALTER TABLE SHRINK SAPCE」で

## ディクショナリ管理方式
- いろいろできない
- 「EXTENT MANAGEMET DICTIONARY」を指定したらこの管理方式になる
- エクステント情報は**データディクショナリ表（SYSTEM表領域）で管理**

ローカル管理方式の方がいいし、使われている！！
# エクステントの割り当てタイプ２種類

## AUTOALLOCATE
- Oracleがサイズを自動調整（64K〜1MB以上）
- UNDO表領域は常にこれ

## UNIFORM
- 均一サイズ（例：UNIFORM SIZE 128K）を明示的に指定
- 一時表領域は常にこれ

# 表領域の削除

表領域は通常、制御ファイルとデータディクショナリに記録される

OMF管理なしで
`DROP TABLESPACE D01;`
をすると・・・

制御ファイルから消えるがデータベースディクショナリからは消えない・・・
→INCLUDING CONTENTS AND DATAFILES句を指定すると消える

# データファイルのブロックサイズについて

特に指定なし
デフォルトのブロックサイズ→「DB_BLOCK_SIZE初期化パラメータ」で指定

指定する
「DB_nK_CACHE_SIZE 初期化パラメータ」で指定したサイズ

---
# bigfile / smallfile 表領域

| 種類        | 説明                              |
| --------- | ------------------------------- |
| smallfile | ✅ デフォルト。複数のデータファイルを持てる。         |
| bigfile   | 1つの超巨大データファイル（最大32TB）を持つ。管理が簡便。 |

---
# データ移動のやり方２選

## オフライン移動
- ALTER TABLE 表領域名 OFFLINE;
- mvなどで移動
- ALETR TABLE 表領域名 RENAME DATAFILEでデータファイルが移動したことを認識させる 
- ALTER TABLE 表領域名 ONLINE

## オンライン移動
- ALTER **DATABASE** MOVE DATAFILE [ファイルパス(ID指定可)] TO [ファイルパス]  [REUSE];
REUSE・・・既存ファイルが存在する場合

# OMF(Oracle Managed Files)

- 初期化パラメータで格納先を設定しておけば、**ファイル名・サイズ指定不要**。
- `CREATE TABLESPACE` 時に `DATAFILE` 句を省略できる。
- 削除時は `DROP TABLESPACE` だけで**データファイルごと削除**（OMF管理なら）。

①初期化パラメータでOMF管理するデータファイルの格納先を指定(必須)
`ALTER SYSTEM SET DB_CREATE_FILE_DEST='/u01/app/oracle/omf';`


| 初期化パラメータ                               | 管理対象のファイル                                                                 |
| -------------------------------------- | ------------------------------------------------------------------------- |
| DB_CREATE_FILE_DEST                    | データファイル<br>一時ファイル<br>制御ファイルとREDOファイル<br>(DB_CREATE_ONLINE_LOG_DEST_nが未設定) |
| DB_CREATE_ONLINE_LOG_DEST_n(n=1,2,...) | 制御ファイルとREDOファイル                                                           |
| DB_RECOVERY_FILE_DEST                  | リカバリ関連ファイル<br>制御ファイルとREDOファイル                                             |

②データファイル名を指定せずに表領域作成
`CREATE TABLESPACE omf_tbs DATAFILE SIZE100M;`
→OMF管理となり、①で指定した'/u01/app/oracle/omf'に表領域が格納

`CREATE TABLESPACE omf_tbs;`
→OMF管理となり＋'/u01/app/oracle/omf'に表領域格納＋データファイルのAUTOEXTENDが有効

③表領域削除
`DROP TABLESPACE omf_tbs;`
→OMF管理された表領域は制御ファイルだけでなくデータファイルからも自動削除
