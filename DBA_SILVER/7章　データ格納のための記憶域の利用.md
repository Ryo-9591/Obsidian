# セグメント領域管理方式とは・・・

新しい行データを追加する場合、行データを格納するために
十分な空き容量があるブロックを高速で探し出す仕組み

また、行データのサイズ増加に備えてどれだけブロック内の空き容量を
残しておくかを==PCTFREEパラメータ==で指定できる

# データブロックの構造

![[Pasted image 20250531140717.png]]

ヘッダー領域とデータ格納領域に分かれている
データは格納用領域の末端から格納されていく
ヘッダー領域には管理情報が格納される
ヘッダー領域サイズは可変

# セグメント領域管理方式２種類

### 自動
・空きブロックを4つのレベルに分類してツリー形式で管理
・表レベルの設定項目がPCTFREEのみ
### 手動
・空きブロックをリスト形式で管理
・表レベルの設定項目が(PCTFREE,PCTUSED・・・)多い

---
# 遅延セグメント作成機能の使用法

①DEFFERRED_SEGMENT_CREATION=trueに設定してからセグメントを作る
②CREATE TABLE分にSEGMENT CREATION DEFFERRED句を指定する
※①はデフォルトでtrue

## 遅延セグメントを使用すると・・・
セグメント作成が表の作成時ではなくその表に最初にINSERTされたときになる
## 利点
・データが空の表が沢山ある場合にデータの節約になる
・大量の表を作成するときにメモリの節約になる

ただ・・・
・SYSユーザが所有するセグメントにはこの機能は無効

---
# セグメント縮小問題

`ALTER TABLE EMPLOYEES SHRINK SPACE;`

この情報からわかることは・・・

## ①HWMが調整される

HWM(High Water Mark)とは・・・
「そのセグメントのどこまでデータが買う脳されたことがあるか」

なんで？
COMPACT句がないため
→HWMを引き下げてHWM以降の領域を解放する
あったら？
→HWMは引き下げるが領域の開放はしない
CASCADE句があったら？
→表に作成されている索引に対しても縮小処理をする

## ②行移行が解消するかもしれない

行移行とは・・・
行サイズが拡張するようなUPDATE分を実行したとき、拡張したデータがブロックの空き容量に収まらずに別のブロックに格納された状態

なんで？
セグメントの縮小はそもそも行の移動によって行われるので、治るかもしれない

## ③ローカル管理方式で管理されている表領域である
なんで？
そもそもローカル管理方式にしないとセグメントの縮小ができない

## ④索引を再構築する必要がない
なんで？
セグメント縮小をすると自動で索引の再構築をしてくれる

---
# 特殊なセグメント2種

| 分類        | 説明    | 格納される場所 |
| --------- | ----- | ------- |
| UNDOセグメント | 過去データ | UNDO表領域 |
| 一時セグメント   | 一時データ | 一時表領域   |

上記２つが常にその表領域に格納されるわけではない・・・
例外がある・・・

・一時UNDO機能を使用したときに、UNDOセグメントが一時表領域に格納される
・一時表領域を作成中、一時セグメントが永続表領域に作成される

## UNDOセグメントについて

・UNDOセグメントには１つまたは複数のトランザクションが対応する
・最後のエクステントがトランザクションで埋まったら・・・
①追加でエクステントが割り当てられる
②最初のエクステントに上書きされる
上記２つの動作をする
# 行連鎖と行移行
![[Pasted image 20250531141650.png]]
# 行連鎖

最初から1ブロックに収まらないほど大きな行をINSERT or UPDATEした場合
→行データを分割して保存する

予防するには・・・
ブロックサイズを拡張する
行のデータサイズを小さくする

※データブロックの話
# 行移行

更新によって行サイズが大きくなり元のブロックサイズに収まらなくなった場合
→元のブロックにはポインタが残る

予防するには・・・
PCTFREEの設定を大きくする

※データファイルの話
# 自動セグメント領域管理(ASSM)

セグメントを構成するブロックの空き容量を管理する方法
・ローカル管理表領域出る必要がある
・各ブロックを領域使用率に基づいてツリー形式に4つに分けて管理
・INSERT時、INSERTする行のサイズに適した空き容量のブロックを探す

# 再開可能領域割り当て
## セグメント拡張エラー
表領域でデータファイルの自動拡張がOFFになっているときにデータが挿入されセグメントの拡張が失敗した際、エラーが発生する

セグメント拡張エラーが発生すると処理を最初から再度



# 表圧縮の種類２つ

基本表圧縮

高度な表圧縮